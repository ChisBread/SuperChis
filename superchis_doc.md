# SuperCard CPLD 固件设计文档 (SuperChis.vhd)

## 1. 项目概述

SuperCard 是一个 GBA 烧录卡，包含以下硬件组件：
- **NOR Flash**: 存储 ROM 数据
- **SRAM**: 提供快速读写存储
- **DDR SDRAM**: 提供大容量高速存储
- **CPLD**: 核心控制器，管理所有IO和存储器访问
- **SD Card Interface**: 可选的外部存储扩展

## 2. 接口定义

### 2.1 输入信号
- `CLK50MHz`: 50MHz 主时钟
- `GP_NCS`: GBA 片选信号 (低有效)
- `GP_NWR`: GBA 写使能信号 (低有效)  
- `GP_NRD`: GBA 读使能信号 (低有效)
- `clk3`: 辅助时钟信号
- `GP(15:0)`: GBA 双向数据总线
- `GP_16` ~ `GP_23`: 额外的GBA控制信号

### 2.2 输出信号
#### DDR SDRAM 接口
- `DDR_A(12:0)`: DDR 地址总线
- `DDR_BA(1:0)`: DDR 银行地址
- `DDR_CKE`: DDR 时钟使能
- `DDR_NRAS`, `DDR_NCAS`, `DDR_NWE`: DDR 命令信号

#### Flash/SRAM 接口  
- `FLASH_A(15:0)`: Flash/SRAM 地址总线
- `FLASH_NCE`: Flash 片选 (低有效)
- `FLASH_SRAM_NWE`: Flash/SRAM 写使能 (低有效)
- `FLASH_SRAM_NOE`: Flash/SRAM 读使能 (低有效)
- `SRAM_A16`: SRAM 高位地址

#### SD Card 接口
- `N_SDOUT`: SD卡输出使能 (低有效)
- `SD_CLK`: SD卡时钟
- `SD_CMD`: SD卡命令线 (双向)
- `SD_DAT(3:0)`: SD卡数据线 (双向)

## 3. 功能模块设计

### 3.1 地址映射与模式控制
- **MAP_REG**: 控制访问DDR SDRAM还是Flash/SRAM
- **SDENABLE**: 控制SD卡功能是否启用
- **魔术地址解锁**: 特殊地址序列用于切换工作模式

### 3.2 DDR SDRAM 控制器
#### 功能
- 管理DDR SDRAM的初始化和刷新
- 实现行激活、读写、预充电命令序列
- 地址多路复用 (行地址/列地址)
- 银行管理

#### 状态机
- **空闲状态**: 等待访问请求
- **行激活**: 激活指定行地址
- **读写操作**: 执行数据传输
- **预充电**: 关闭激活的行
- **刷新**: 定期刷新操作

#### 时序控制
- 使用内部计数器管理tRAS, tRP, tRCD等时序
- CKE信号控制DDR的时钟使能
- 命令信号的精确时序控制

### 3.3 Flash/SRAM 控制器
#### 地址生成
- 支持多种地址映射模式
- 银行切换功能，扩展可访问空间
- 内部地址计数器，支持连续访问

#### 片选控制
- 基于地址范围和模式寄存器决定片选
- 与SD卡访问互斥控制

### 3.4 SD卡接口控制器
#### SPI模式支持
- 生成SD卡SPI时钟
- 管理CMD和DAT线的数据传输
- 状态机控制SD卡命令序列

#### 数据路径
- GP总线到SD卡的数据映射
- 支持4位并行数据传输
- 输出使能控制

### 3.5 总线仲裁器
#### GP总线复用
- 根据访问模式切换GP总线的数据源
- DDR数据、Flash数据、SD卡数据的多路选择
- 输出使能控制，避免总线冲突

#### 时序同步
- 同步GBA的读写时序
- 处理不同存储器的访问延迟
- 时钟域同步

## 4. 关键设计要点

### 4.1 状态机设计
- 使用有限状态机管理DDR访问
- 状态转换基于GBA的控制信号
- 内部计数器跟踪时序要求

### 4.2 时钟管理
- 50MHz主时钟用于高速逻辑
- GBA控制信号的边沿触发逻辑
- 多时钟域同步设计

### 4.3 配置寄存器
- 通过特殊地址写入配置数据
- 魔术解锁序列保护配置更改
- 运行时模式切换支持

### 4.4 地址空间分配
```
0x00000000 - 0x01FFFFFF: Flash ROM (32MB)
0x02000000 - 0x03FFFFFF: DDR SDRAM (32MB) 
0x04000000 - 0x04007FFF: SRAM (32KB)
0x05000000 - 0x05FFFFFF: SD Card Access
```

## 5. 实现优先级

### 第一阶段：基础功能
1. Flash/SRAM基本读写
2. 地址解码和片选控制
3. GP总线基本数据传输

### 第二阶段：DDR支持  
1. DDR SDRAM初始化
2. 基本读写操作
3. 刷新控制

### 第三阶段：高级功能
1. SD卡接口
2. 模式切换和配置
3. 性能优化

## 6. 测试策略

### 6.1 仿真测试
- 各模块单独功能测试
- 总线时序验证
- 状态机覆盖率测试

### 6.2 硬件测试  
- GBA实际连接测试
- 存储器读写正确性验证
- 时序裕量测试

## 7. 约束和注意事项

- CPLD资源限制，需要优化逻辑复杂度
- 时序约束严格，特别是DDR接口
- 功耗控制，避免不必要的翻转
- 兼容性考虑，支持不同GBA型号
